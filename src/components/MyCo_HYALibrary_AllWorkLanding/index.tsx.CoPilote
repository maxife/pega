import React from 'react';
import * as ReactDOM from 'react-dom';
import { Table } from '@pega/cosmos-react-core';

/** ---------- Types ---------- */
type PoliceRow = {
  id: string;              // cl√© unique requise par Cosmos/TS
  numeroPolice: string;    // "N¬∞ police"
  souscripteur: string;
  intermediaire: string;
  statut: string;
  prime: string | number;  // nombre ou string d√©j√† format√©e
  sp: string;              // ex: "50%"
  tacheEtape: string;      // "T√¢che / √âtape"
};

/** ---------- Donn√©es ---------- */
const items: PoliceRow[] = [
  {
    id: '4000P234567',
    numeroPolice: '4000P234567',
    souscripteur: 'DM Apro',
    intermediaire: 'Super courtier',
    statut: 'Projet',
    prime: '10 000 ‚Ç¨',
    sp: '50%',
    tacheEtape: 'En n√©gociation',
  },
  {
    id: '4000P234568',
    numeroPolice: '4000P234568',
    souscripteur: 'COFAQ',
    intermediaire: 'Assuraction',
    statut: 'Assur√©',
    prime: 25000,
    sp: '60%',
    tacheEtape: "Demande d'option",
  },
  {
    id: '4000P234569',
    numeroPolice: '4000P234569',
    souscripteur: 'ExaCOM',
    intermediaire: 'Courtier SA',
    statut: 'Assur√©',
    prime: 7000,
    sp: '45%',
    tacheEtape: "Demande d'am√©nagement technique",
  },
  {
    id: '4000P234570',
    numeroPolice: '4000P234570',
    souscripteur: 'InterCollect',
    intermediaire: 'Jemassure',
    statut: 'Projet',
    prime: 15000,
    sp: '40%',
    tacheEtape: 'En n√©gociation',
  },
  {
    id: '4000P234571',
    numeroPolice: '4000P234571',
    souscripteur: 'NEXOCTOM',
    intermediaire: 'Jemassure',
    statut: 'Projet',
    prime: 15000,
    sp: '40%',
    tacheEtape: 'En n√©gociation',
  },
  {
    id: '4000P234572',
    numeroPolice: '4000P234572',
    souscripteur: 'ALGOREL',
    intermediaire: 'Courtier&Co',
    statut: 'Assur√©',
    prime: 30000,
    sp: '70%',
    tacheEtape: "Demande d'option",
  },
];

/** ---------- Colonnes Cosmos ---------- */
// NOTE : la colonne "actions" n'existe pas dans PoliceRow ; on la rend via cellRenderer.
 const columns = [
  { key: 'numeroPolice', label: 'N¬∞ police', sortable: true },
  { key: 'souscripteur', label: 'Souscripteur', sortable: true },
  { key: 'intermediaire', label: 'Interm√©diaire', sortable: true },
  { key: 'statut', label: 'Statut', sortable: true },
  { key: 'prime', label: 'Prime', sortable: true },
  { key: 'sp', label: 'S/P', sortable: true },
  { key: 'tacheEtape', label: 'T√¢che / √âtape', sortable: true },
  { key: 'actions', label: 'D√©tails' },
];

/** ---------- Utilitaire ---------- */
const formatEuro = (v: string | number) =>
  typeof v === 'number'
    ? new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v)
    : v;

/** ---------- Drawer lat√©ral accessible ---------- */
function DetailsDrawer(props: {
  open: boolean;
  title: string;
  onClose: () => void;
  children: React.ReactNode;
}) {
  const { open, title, onClose, children } = props;
  const panelRef = React.useRef<HTMLDivElement | null>(null);
  const lastActive = React.useRef<HTMLElement | null>(null);

  React.useEffect(() => {
    if (!open) return;
    // M√©moriser l'√©l√©ment focus
    lastActive.current = document.activeElement as HTMLElement | null;

    // Focus initial dans le drawer
    const toFocus =
      panelRef.current?.querySelector<HTMLElement>(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      ) ?? panelRef.current;
    toFocus?.focus?.();

    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        onClose();
      }
    };
    document.addEventListener('keydown', onKey);
    return () => document.removeEventListener('keydown', onKey);
  }, [open, onClose]);

  React.useEffect(() => {
    if (!open) return;
    // Rendre le focus o√π il √©tait
    return () => lastActive.current?.focus?.();
  }, [open]);

  if (!open) return null;

  return ReactDOM.createPortal(
    <div
      onClick={(e) => {
        // Fermer au clic hors panneau
        if (e.target === e.currentTarget) onClose();
      }}
      style={{
        position: 'fixed',
        inset: 0,
        background: 'rgba(17,24,39,0.35)', // overlay
        display: 'flex',
        justifyContent: 'flex-end',
        zIndex: 1000,
      }}
      aria-hidden={false}
    >
      <div
        ref={panelRef}
        role="dialog"
        aria-modal="true"
        aria-labelledby="details-drawer-title"
        tabIndex={-1}
        onClick={(e) => e.stopPropagation()}
        style={{
          background: '#fff',
          width: 420,
          height: '100vh',
          borderLeft: '1px solid #d1d5db',
          boxShadow: '-8px 0 24px rgba(0,0,0,0.15)',
          display: 'flex',
          flexDirection: 'column',
        }}
      >
        {/* Header */}
        <div
          style={{
            background: '#e9edf2',
            color: '#1f2d3d',
            padding: '0.75rem 1rem',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            fontWeight: 600,
            borderBottom: '1px solid #d1d5db',
          }}
        >
          <span id="details-drawer-title">{title}</span>
          <button
            type="button"
            onClick={onClose}
            aria-label="Fermer"
            style={{
              border: 'none',
              background: 'transparent',
              color: '#374151',
              fontSize: '1.25rem',
              cursor: 'pointer',
              lineHeight: 1,
            } as React.CSSProperties}
          >
            √ó
          </button>
        </div>

        {/* Body */}
        <div style={{ padding: '0.75rem 1rem 1rem', display: 'grid', gap: '0.5rem', overflowY: 'auto' }}>
          {children}
        </div>
      </div>
    </div>,
    document.body
  );
}

/** ---------- Composant export√© par d√©faut pour DXCB ---------- */
export default function MyCoHyaLibraryAllWorkLanding() {
  const [selected, setSelected] = React.useState<PoliceRow | null>(null);
  const [open, setOpen] = React.useState(false);

  const openDetails = (row: PoliceRow) => {
    setSelected(row);
    setOpen(true);
  };
  const closeDetails = () => setOpen(false);

  return (
    <>
      <Table
        aria-label="Mes dossiers"
        // ‚ö†Ô∏è Selon version Cosmos, remplacez items par rows ou data si n√©cessaire.
        data={items}
        columns={columns}
        density="compact"
        stickyHeader
        selectionMode="none"


        // Renderer robuste quelle que soit la signature (column vs colKey)
        cellRenderer={(columnOrKey: any, row: PoliceRow) => {
          const colKey =
            typeof columnOrKey === 'string'
              ? columnOrKey
              : columnOrKey?.key ?? columnOrKey?.id ?? columnOrKey?.accessor;

          if (!colKey) return '';

          // Formatage de "Prime"
          if (colKey === 'prime') {
            return typeof row?.prime === 'number'
              ? new Intl.NumberFormat('fr-FR', {
                  style: 'currency',
                  currency: 'EUR',
                  maximumFractionDigits: 0,
                }).format(row.prime as number)
              : row?.prime ?? '';
          }

          // Colonne "actions": loupe + bouton "D√©tails"
          if (colKey === 'actions') {
            return (
              <div style={{ display: 'flex', alignItems: 'center', gap: '.5rem', justifyContent: 'center' }}>
                <button
                  type="button"
                  onClick={() => openDetails(row)}
                  title={`Afficher le d√©tail de ${row.numeroPolice}`}
                  aria-label={`Afficher le d√©tail de ${row.numeroPolice}`}
                  style={{
                    width: '2rem',
                    height: '2rem',
                    borderRadius: '50%',
                    border: '1px solid #d1d5db',
                    background: '#fff',
                    display: 'inline-flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                    lineHeight: 1,
                  }}
                >
                  üîç
                </button>
                <button
                  type="button"
                  onClick={() => openDetails(row)}
                  style={{
                    border: '1px solid #d1d5db',
                    background: '#fff',
                    padding: '0.25rem 0.75rem',
                    cursor: 'pointer',
                    fontSize: '0.875rem',
                    color: '#374151',
                    borderRadius: 6,
                  }}
                >
                  D√©tails
                </button>
              </div>
            );
          }

          // Valeur par d√©faut
          return (row as any)?.[colKey] ?? '';
        }}
      />

      {/* Drawer lat√©ral de d√©tails */}
      <DetailsDrawer
        open={open && !!selected}
        title={selected ? selected.souscripteur : 'Synth√®se'}
        onClose={closeDetails}
      >
        {selected && (
          <div style={{ display: 'grid', gap: '0.5rem' }}>
            {/* Bandeau titre + statut */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline' }}>
              <div style={{ fontWeight: 600, color: '#1f2d3d' }}>{selected.souscripteur}</div>
              <span
                style={{
                  borderRadius: 6,
                  padding: '0.125rem 0.5rem',
                  background: selected.statut === 'Assur√©' ? '#def7ec' : '#e5efff',
                  color: selected.statut === 'Assur√©' ? '#03543f' : '#1e3a8a',
                  fontSize: '0.75rem',
                  border: '1px solid #d1d5db',
                }}
              >
                {selected.statut}
              </span>
            </div>

            {/* Carte synth√®se */}
            <div
              style={{
                border: '1px solid #d1d5db',
                borderRadius: 8,
                background: '#fff',
                padding: '0.5rem 0.75rem',
                display: 'grid',
                gap: '0.5rem',
              }}
            >
              <div style={{ fontWeight: 600, color: '#1f2d3d' }}>Synth√®se</div>

              <dl
                style={{
                  margin: 0,
                  display: 'grid',
                  gridTemplateColumns: '1fr auto',
                  rowGap: '0.35rem',
                  columnGap: '0.75rem',
                }}
              >
                <dt style={{ color: '#6b7280' }}>N¬∞ police</dt>
                <dd style={{ margin: 0 }}>{selected.numeroPolice}</dd>

                <dt style={{ color: '#6b7280' }}>Interm√©diaire</dt>
                <dd style={{ margin: 0 }}>{selected.intermediaire}</dd>

                <dt style={{ color: '#6b7280' }}>Prime</dt>
                <dd style={{ margin: 0 }}>{formatEuro(selected.prime)}</dd>

                <dt style={{ color: '#6b7280' }}>S/P</dt>
                <dd style={{ margin: 0 }}>{selected.sp}</dd>

                <dt style={{ color: '#6b7280' }}>T√¢che / √âtape</dt>
                <dd style={{ margin: 0 }}>{selected.tacheEtape}</dd>
              </dl>

              <div>
                <a
                  href="#"
                  onClick={(e) => {
                    e.preventDefault();
                    // Branche ici la vraie navigation vers une vue d√©taill√©e
                    console.log('Afficher plus de d√©tails pour', selected.numeroPolice);
                  }}
                  style={{ color: '#1e3a8a', textDecoration: 'underline' }}
                >
                  Afficher plus de d√©tails‚Ä¶
                </a>
              </div>
            </div>
          </div>
        )}
      </DetailsDrawer>
    </>
  );
}
